<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>OfficeOnFire</title>
</head>
<body>
  <h1>OfficeOnFire</h1>
  <pre id="status">Loading...</pre>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    import ModuleFactory from './build/OfficeOnFire.js';

    // Initialize Supabase
    const supabaseUrl = '<supabaseUrl>';
    const supabaseKey = '<supabaseKey>';
    const supabase = createClient(supabaseUrl, supabaseKey);

    // Initialize WASM module
    const Module = await ModuleFactory({
      locateFile: path => './build/' + path,
    });

    const game = new Module.Game();
    const playerId = Math.floor(Math.random()*100000).toString();

    // Sync with Supabase
    async function updatePosition() {
      console.log({
        id: playerId,
        x: game.getPlayer().x,
        y: game.getPlayer().y,
        floor: game.getPlayer().floor
      });
      await supabase.from('players').upsert({
        id: playerId,
        x: game.getPlayer().x,
        y: game.getPlayer().y,
        floor: game.getPlayer().floor
      });
    }

    // âœ… Correct realtime subscription for supabase-js v2
    const channel = supabase
      .channel('realtime:players')
      .on(
        'postgres_changes',
        { event: '*', schema: 'public', table: 'players' },
        payload => {
          console.log('Change received!', payload);
        }
      )
      .subscribe();

    // Handle movement
    document.addEventListener('keydown', async e => {
      if (["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(e.key)) {
        game.movePlayer(e.key);
        document.getElementById('status').textContent =
          `You are at (${game.getPlayer().x}, ${game.getPlayer().y}) floor ${game.getPlayer().floor}`;
        await updatePosition();
      }
    });

    document.getElementById('status').textContent =
      `You are at (${game.getPlayer().x}, ${game.getPlayer().y}) floor ${game.getPlayer().floor}`;
  </script>
</body>
</html>